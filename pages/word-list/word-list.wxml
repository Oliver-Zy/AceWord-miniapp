<wxs module="tools" src="./word-list.wxs"></wxs>

<!-- S container -->
<view class="container">

  <!-- S scroll-view -->
  <scroll-view 
    scroll-y="true" 
    refresher-enabled="true" 
    refresher-triggered="{{isRefresherTriggered}}" 
    style="height:{{scrollViewHeight}}px;position:fixed;top:{{naviBarHeight}}px;" 
    bind:refresherrefresh="onScrollViewRefresh">
    
    <!-- 顶部间距 -->
    <view style="height: 20px;"></view>


    <!-- S word list -->
    <view wx:if="{{tools.getTotalWordCount(wordGroupsByDate) > 0}}" class="word-list-container">
      <block wx:for="{{wordGroupsByDate}}" wx:key="date" wx:for-item="dateGroup">
        <view class="date-card">
          <van-collapse 
            value="{{ activeNames }}" 
            bind:change="onCollapseChange"
            border="{{ false }}">
            
            <van-collapse-item 
              title="{{dateGroup.dateDisplay || tools.formatDateDisplay(dateGroup.date)}}" 
              name="{{dateGroup.date}}"
              custom-class="collapse-item">
              
              <view slot="value" class="date-word-count">{{dateGroup.wordCount}}词</view>
              
              <!-- S word list content -->
              <view class="date-group-container">
                <block wx:for="{{dateGroup.wordList}}" wx:key="wordId" wx:for-item="wordItem" wx:for-index="wordIndex">
                  <view class="word-item" 
                        bind:tap="onMeaningTap" 
                        data-word-id="{{wordItem.wordId}}"
                        hover-class="none">
                    <!-- S word item content -->
                    <view class="word-item-content">
                      <!-- S left content -->
                      <view class="word-item-left">
                        <view class="word-name" catchtap="onWordItemTap" data-date-index="{{index}}" data-word-index="{{wordIndex}}" hover-class="none">{{wordItem.wordName}}</view>              
                        <view class="meaning-text {{visibleMeanings[wordItem.wordId] ? '' : 'blurred'}}">
                          {{wordItem.selfDef || wordItem.wordCN || '暂无释义'}}
                        </view>
                      </view>
                      <!-- E left content -->

                      <!-- S right content -->
                      <view class="word-item-right">
                        <view class="proficiency-text" 
                              catchtap="onProficiencyTap" 
                              data-date-index="{{index}}" 
                              data-word-index="{{wordIndex}}"
                              data-word-id="{{wordItem.wordId}}"
                              data-word-name="{{wordItem.wordName}}"
                              data-current-opacity="{{wordItem.opacity}}"
                              hover-class="proficiency-hover"
                              style="color: {{wordItem.proficiencyColor}};">
                          {{wordItem.proficiencyText}}
                        </view>
                      </view>
                      <!-- E right content -->
                    </view>
                    <!-- E word item content -->

                    <!-- S divider -->
                    <view wx:if="{{wordIndex !== dateGroup.wordList.length - 1}}" class="divider"></view>
                    <!-- E divider -->
                  </view>
                </block>
              </view>
              <!-- E word list content -->
              
            </van-collapse-item>
            
          </van-collapse>
        </view>
        
        <!-- 日期分组间距 -->
        <view wx:if="{{index !== wordGroupsByDate.length - 1}}" style="height: 12px;"></view>
      </block>
    </view>
    <!-- E word list -->
    
    <!-- S empty state -->
    <view wx:if="{{isLoaded && wordGroupsByDate.length == 0}}" class="empty-state">
      <view class="empty-text">暂无新学单词</view>
      <view class="empty-subtext">还没有新学记录</view>
    </view>
    <!-- E empty state -->

    <!-- S load more section -->
    <view wx:if="{{isLoaded && wordGroupsByDate.length > 0 && hasMoreData && !isLoadingMore}}" style="padding:28px 0;display:flex;justify-content:center;align-items:center;gap:12px;">
      <ace-button size="small" text="加载更多" bind:btnEvent="onLoadMore" />
    </view>
    
    <!-- S end divider -->
    <view wx:if="{{isLoaded && wordGroupsByDate.length > 0 && !hasMoreData}}" style="padding:28px 0;display:flex;justify-content:center;">
      <text style="font-family:var(--poppins-italic);font-size:12px;color:#7987A3;">- Rome wasn't built in a day -</text>
    </view>
    <!-- E end divider -->
    <!-- E load more section -->

    <view style="height:{{selectedWordIds.length != 0 ? 62 : 0}}px;"></view>
  </scroll-view>
  <!-- E scroll-view -->

</view>
<!-- E container -->

<!-- S practice button -->
<view wx:if="{{selectedWordIds.length != 0}}" style="display:flex;justify-content:center;position:absolute;left:50%;transform:translate(-50%);bottom:{{ isIOS ? 100 : 70}}px;overflow: hidden;">
  <ace-button size="large" text="开始练习" bind:btnEvent="onPractice" />
</view>
<!-- E practice button -->

<!-- S dic-card -->
<view style="position:fixed;bottom:0;z-index:3;">
  <dic-card id="dic-card" wx:if="{{showDicCard}}" wordInfo="{{wordInfo}}" showReplaceBtn="{{false}}" showStyleBtn="{{false}}" bind:dicCardEvent="onDicCardEvent" />
  <view style="height:100px;" bind:tap="onClickHideOverlay"></view>
</view>
<!-- E dic-card -->

<!-- S overlay -->
<view wx:if="{{showOverlay}}" class="overlay" bind:tap="onClickHideOverlay"></view>
<!-- E overlay -->

<!-- S ace components -->
<ace-navi-bar type="calendar" title="单词库" backgroundColor="rgba(0,0,0,0)" showDivider="{{showNaviBarDivider}}" style="width:100%;position:fixed;top:0;" />
<!-- E ace components -->

<!-- S vant components -->
<van-toast id="van-toast" />
<van-popup show="{{ showProficiencyPopup }}" position="bottom" overlay="{{ false }}" duration="0" bind:close="onCloseProficiencySheet">
  <van-action-sheet 
    show="{{ showProficiencySheet }}" 
    description="选择该单词的熟练程度" 
    actions="{{ proficiencyActions }}" 
    cancel-text="取消" 
    bind:select="onSelectProficiency" 
    bind:cancel="onCloseProficiencySheet" 
    bind:click-overlay="onCloseProficiencySheet" />
</van-popup>
<!-- E vant components -->
